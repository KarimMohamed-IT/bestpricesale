@page
@model bestpricesale.Pages.Admin.PageEditorModel
@{
    ViewData["Title"] = "Page Builder";
}

<h2 class="text-2xl font-bold mb-4">Page Builder</h2>

<form method="post" id="pageMetaForm" class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="Page.Title" class="form-label">Title</label>
            <input asp-for="Page.Title" class="form-control" placeholder="Enter page title" aria-label="Page Title" />
        </div>
        <div class="col-md-6">
            <label asp-for="Page.Slug" class="form-label">Slug</label>
            <input asp-for="Page.Slug" class="form-control" placeholder="Enter page slug" aria-label="Page Slug" />
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Template</label>
        <select asp-for="Page.TemplateId" asp-items="Model.TemplateOptions" class="form-select" aria-label="Select Template"></select>
    </div>
    <input type="hidden" id="Content" name="Page.Content" value="@Model.Page.Content" />
    <button type="submit" class="btn btn-primary">Save Page</button>
</form>

<div id="gjs" style="height: 700px; border: 1px solid #ccc; margin-top: 20px;">
    @Html.Raw(Model.Page.Content)
</div>

<button id="previewBtn" class="mt-4 btn btn-success">Preview Page</button>

@section Scripts {
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/grapesjs"></script>
    <script>
        var editor = grapesjs.init({
            container: '#gjs',
            height: '700px',
            fromElement: true,
            storageManager: { autoload: 0 },
            plugins: ['gjs-blocks-basic'],
            pluginsOpts: {
                'gjs-blocks-basic': {}
            }
        });

        document.getElementById("pageMetaForm").addEventListener("submit", function(e) {
            var title = document.getElementById("Page_Title").value;
            var slug = document.getElementById("Page_Slug").value;

            if (!title || !slug) {
                e.preventDefault();
                alert("Title and Slug are required!");
            } else {
                var htmlContent = editor.getHtml();
                document.getElementById("Content").value = htmlContent;
            }
        });

        document.getElementById("previewBtn").addEventListener("click", function() {
            var htmlContent = editor.getHtml();
            var previewWindow = window.open();
            previewWindow.document.write(htmlContent);
            previewWindow.document.close();
        });

        setInterval(function() {
            var htmlContent = editor.getHtml();
            localStorage.setItem('autoSaveContent', htmlContent);
            console.log("Auto-saved content.");
        }, 10000);

        window.addEventListener("load", function() {
            var savedContent = localStorage.getItem('autoSaveContent');
            if (savedContent) {
                editor.setComponents(savedContent);
            }
        });
    </script>
}